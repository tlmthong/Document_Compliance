# Docker Compose for RegCompliance Full Stack
# Includes PostgreSQL with pgvector and all application services

version: '3.8'

services:
  # Ollama LLM Service
  ollama:
    image: ollama/ollama:latest
    container_name: regcompliance_ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    restart: unless-stopped
    networks:
      - regcompliance-network
    # Uncomment below for GPU support on Linux
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # PostgreSQL Database with pgvector
  policy-db:
    image: pgvector/pgvector:pg16
    container_name: regcompliance_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: policy_db
    volumes:
      - policy-db-volume:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d policy_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - regcompliance-network

  # Database initialization service (runs once)
  db-init:
    build: .
    container_name: regcompliance_db_init
    command: python CreateTablePG.py
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      DB_HOST: policy-db
      DB_PORT: "5432"
      DB_NAME: policy_db
      DB_USER: postgres
      DB_PASSWORD: postgres
    depends_on:
      policy-db:
        condition: service_healthy
    networks:
      - regcompliance-network
    restart: "no"

  # PolicyAPI Service (Main LLM API)
  policy-api:
    build: .
    container_name: regcompliance_policy_api
    command: python PolicyAPI.py
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      DB_HOST: policy-db
      DB_PORT: "5432"
      DB_NAME: policy_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      OPENAI_API_KEY: "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"
      HF_HUB_OFFLINE: "0"
      OLLAMA_HOST: "http://ollama:11434"
    ports:
      - "8000:8000"
    volumes:
      - ./prompts:/app/prompts:ro
      - ./documents:/app/documents:ro
      - hf-cache:/root/.cache/huggingface
    depends_on:
      policy-db:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      ollama:
        condition: service_started
    networks:
      - regcompliance-network
    restart: unless-stopped

  # ProcessFlow Service (Policy Processing)
  process-flow:
    build: .
    container_name: regcompliance_process_flow
    command: python ProcessFlow.py
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      DB_HOST: policy-db
      DB_PORT: "5432"
      DB_NAME: policy_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      POLICY_API_HOST: "http://policy-api:8000"
    ports:
      - "6868:6868"
    volumes:
      - ./import:/app/import
      - ./documents:/app/documents:ro
    depends_on:
      policy-db:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      policy-api:
        condition: service_started
    networks:
      - regcompliance-network
    restart: unless-stopped

  # JudgeFlow Service (Judgment Processing)
  judge-flow:
    build: .
    container_name: regcompliance_judge_flow
    command: python JudgeFlow.py
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      DB_HOST: policy-db
      DB_PORT: "5432"
      DB_NAME: policy_db
      DB_USER: postgres
      DB_PASSWORD: postgres
      POLICY_API_HOST: "http://policy-api:8000"
    ports:
      - "6969:6969"
    volumes:
      - ./form:/app/form
    depends_on:
      policy-db:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      policy-api:
        condition: service_started
    networks:
      - regcompliance-network
    restart: unless-stopped

  # Frontend (Nginx serving static files)
  frontend:
    image: nginx:alpine
    container_name: regcompliance_frontend
    ports:
      - "80:80"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - process-flow
      - judge-flow
    networks:
      - regcompliance-network
    restart: unless-stopped

networks:
  regcompliance-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "0.0.0.0"
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  policy-db-volume:
  hf-cache:
  ollama-models:
